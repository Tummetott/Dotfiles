# vim: set ft=bash:

if ! has snap; then
    {
        sudo apt -y update
        sudo apt -y install snapd

        {{ if and (eq .chezmoi.os "linux") (eq .chezmoi.osRelease.id "kali") }}
        sudo systemctl enable --now snapd snapd.apparmor
        {{ end }}

    } >> "$BOOTSTRAP_LOG_FILE" 2>&1

    warn 'Could not install snap packages because the system needs a restart!'

    # Update the repeat.hash content with a new SHA hash of the current time.
    # This action ensures that the install script re-executes after running
    # 'chezmoi apply' on a rebooted system.
    date | shasum | awk '{print $1}' > "$XDG_DATA_HOME/chezmoi/.scriptstate/repeat.hash"

else
    info 'Install packages from Snapfile'
    while read -r line; do
        sudo snap install $line >> "$BOOTSTRAP_LOG_FILE" 2>&1
    done < <(grep -vE '^\s*(#|$)' "$XDG_CONFIG_HOME/snap/Snapfile")
fi
