#!/usr/bin/env bash
# vim: set ft=bash:

source ~/.local/share/chezmoi/.script_helper
set -euo pipefail
trap on_error ERR
source ~/.config/shell/env

# HACK: This comment is important, otherwise an error occurs. This must be a bug
# of chezmoi.

# Configurations for macOS
{{- if eq .chezmoi.os "darwin" }}
    {{-   template "macos-configure.tmpl" . -}}
    {{-   template "tmux-terminfo.tmpl" . -}}
{{- end }}

# Configurations for Ubuntu
{{- if and (eq .chezmoi.os "linux") (eq .chezmoi.osRelease.id "ubuntu") }}
    {{-   template "ubuntu-configure.tmpl" . -}}
{{- end }}

# Configurations for popOS
{{- if and (eq .chezmoi.os "linux") (eq .chezmoi.osRelease.id "pop") }}
    # TODO
{{- end }}

# Configurations for Kali
{{- if and (eq .chezmoi.os "linux") (eq .chezmoi.osRelease.id "kali") }}
    {{-   template "kali-configure.tmpl" . -}}
{{- end }}

# Configurations for pi
{{- if and (eq .chezmoi.os "linux") (eq .chezmoi.osRelease.id "raspbian") }}
    # TODO
{{- end }}

if has zsh; then
    info 'Install zsh plugins'
    # The TMUX env ensures that tmux is not started when executing .zshrc
    TMUX=1 zsh -c 'source $XDG_CONFIG_HOME/zsh/.zshrc' >> "$BOOTSTRAP_LOG_FILE" 2>&1
fi

if has nvim; then
    info 'Install nvim plugins'
    # TODO: this command does not install all neovim plugins
    nvim --headless '+Lazy! sync' +qa >> "$BOOTSTRAP_LOG_FILE" 2>&1
fi

# Change git remote from HTTPS to SSH
pushd "$HOME/.local/share/chezmoi"
git remote set-url origin git@github.com:tummetott/dotfiles.git
popd

# hash=$($HOME/.local/bin/chezmoi state data | grep -E '\\"name\\": \\"1-packages\\"' | awk -F '"' '{print $2}')

{{- if eq .chezmoi.os "darwin" }}
    compl 'Installation successful. You should restart now.'
{{- else if eq .chezmoi.os "linux" }}
    # Force restart when on linux
    compl 'Installation successful. Press any key to restart'
    read -n 1 -s -r
    sudo reboot now
{{- end }}
